<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
        <title>JQuery Validation Engine</title>
        <link rel="stylesheet" href="../css/validationEngine.jquery.css" type="text/css"/>
        <link rel="stylesheet" href="../css/template.css" type="text/css"/>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.validate/1.7/jquery.validate.min.js"></script>
        <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>

        <script src="../js/jquery-1.6.min.js" type="text/javascript">
        </script>
        <script src="../js/languages/jquery.validationEngine-en.js" type="text/javascript" charset="utf-8">
        </script>
        <script src="../js/jquery.validationEngine.js" type="text/javascript" charset="utf-8">
        </script>
        <script src="../js/contrib/other-validations.js" type="text/javascript" charset="utf-8">
        </script>
        <script>
            jQuery(document).ready(function(){
                // binds form submission and fields to the validation engine
                jQuery("#formID").validationEngine('attach');
                
            });
        </script>
    </head>
    <body>
        <p>
            <a href="#" onclick="alert('is the form valid? '+jQuery('#formID').validationEngine('validate'))">Evaluate form</a>
            | <a href="#" onclick='jQuery("#formID").validationEngine("validateField", "#email");'>Evaluate one field</a>
            | <a href="#" onclick="jQuery('#formID').validationEngine('showPrompt', 'This is an example', 'pass')">Build a prompt on a div</a>
            | <a href="#" onclick="jQuery('#formID').validationEngine('hide')">Close all prompts</a>
            | <a href="#" onclick="jQuery('#telephone').validationEngine('hidePrompt')">Close Telephone prompt</a>
			| <a href="../index.html" >Back to index</a>
        </p>
        <p>
            Add your Party Hall
        </p>
        <form id="formID" class="formular" method="post" action="">
            <fieldset>
                <legend>
                    Address
                </legend>
                <label>
                    Enter your complete address
                    <br />
                    <span>Address : </span>
                    <textarea id="FullAddress" name="FullAddress" class="fulladdressvalidator" rows="2" cols="20" name="ta" id="ta" ></textarea>
                </label>
                <legend>
                    Phone
                </legend>
                <label>
                    +103-304-340-4300-043
                    <br/>
                    +1 305 768 23 34 ext 23
                    <br/>
                    <span>Phone : </span>
                    <input value="+1 305 768 23 34 ext 23 BUG" class="validate[required,custom[phone]] text-input" type="text" name="telephone" id="telephone" />
                </label>
            
                <legend>
                    URL
                </legend>
                <label>
                    URL begin with http:// https:// or ftp://
                    <br/>
                    <span>Enter a URL : </span>
                    <input value="http://" class="validate[required,custom[url]] text-input" type="text" name="url" id="url" />
                </label>
            
                <legend>
                    Email
                </legend>
                <label>
                    <span>Email address : </span>
                    <input value="" class="validate[required,custom[email]] text-input" type="text" name="email" id="email" />
                </label>
                <label>
                    <span>Please select a file:</span>
                    <input class="validate[required] text-input" type="file" name="file" id="file"/>
                </label>
            </fieldset>
            <input class="submit" type="submit" value="Submit"/><hr/>
        </form>
        

        <script type="text/javascript">
        // The following code show execute only after the page is fully loaded
        $(document).ready(function () {
            if ($('#formID').exists()) {

                // Enable jQuery Validation for the form
                $("#formID").validate({ onkeyup: false });

                // Add validation rules to the FullAddress field
                $("#FullAddress").rules("add", {
                    fulladdress: true,
                    required: true,
                    messages: {
                        fulladdress: "Google cannot locate this address."
                    }
                });

                // This function will be executed when the form is submitted
                function FormSubmit() {
                    $.submitForm = true;
                    if (!$('#formID').valid()) {
                        return false;
                    } else {
                        if ($("#FullAddress").data("IsChecking") == true) {
                            $("#FullAddress").data("SubmitForm", true);
                            return false;
                        }

                        alert('Form Valid!  Submit!');
                        // return true;   // Uncomment to submit the form.
                        return false;     // Supress the form submission for test purpose.
                        
                    }
                }

                // Attach the FormSubmit function to the Submit button
                if ($('#Submit').exists()) {
                    $("#Submit").click(FormSubmit);
                }

                // Execute the ForumSubmit function when the form is submitted
                $('#formID').submit(FormSubmit);
            }
        });

        // Create a jQuery exists method
        jQuery.fn.exists = function () { return jQuery(this).length > 0; }

        // Position the Google Map
        function Map(elementId, geolocation) {
            var myOptions = {
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            var map = new google.maps.Map(document.getElementById(elementId), myOptions);
            map.setCenter(geolocation);
        }

        // FullAddress jQuery Validator
        function FullAddressValidator(value, element, paras) {

            // Convert the value variable into something a bit more descriptive
            var CurrentAddress = value;

            // If the address is blank, then this is for the required validator to deal with.
            if (value.length == 0) {
                return true;
            }

            // If we've already validated this address, then just return the previous result
            if ($(element).data("LastAddressValidated") == CurrentAddress) {
                return $(element).data("IsValid");
            }

            // We have a new address to validate, set the IsChecking flag to true and set the LastAddressValidated to the CurrentAddress
            $(element).data("IsChecking", true);
            $(element).data("LastAddressValidated", CurrentAddress);

            // Google Maps doesn't like line-breaks, remove them 
            CurrentAddress = CurrentAddress.replace(/\n/g, "");

            // Create a new Google geocoder
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': CurrentAddress }, function (results, status) {

                // The code below only gets run after a successful Google service call has completed.  
                // Because this is an asynchronous call, the validator has already returned a 'true' result
                // to supress an error message and then cancelled the form submission.  The code below 
                // needs to fetch the true validation from the Google service and then re-execute the 
                // jQuery form validator to display the error message.  Futhermore, if the form was 
                // being submitted, the code below needs to resume that submit.

                // Google reported a valid geocoded address
                if (status == google.maps.GeocoderStatus.OK) {

                    // Get the formatted Google result
                    var address = results[0].formatted_address;

                    // Count the commas in the fomatted address.   
                    // This doesn't look great, but it helps us understand how specific the geocoded address
                    // is.  For example, "CA" will geocde to "California, USA".  
                    numCommas = address.match(/,/g).length;

                    // A full street address will have at least 3 commas.  Alternate techniques involve 
                    // fetching the address_components returned by Google Maps.  That code looks even more ugly.
                    if (numCommas >= 3) {

                        // Replace the first comma found with a line-break
                        address = address.replace(/, /, "\n");

                        // Remove USA from the address (remove this, if this is important to you)
                        address = address.replace(/, USA$/, "");

                        // Check for the map_canvas, if it exists then position the Google Map
                        if ($("#map_canvas").exists()) {
                            $("#map_canvas").show();
                            Map("map_canvas", results[0].geometry.location);
                        }

                        // Set the textarea value to the geocoded address
                        $(element).val(address);

                        // Cache this latest result
                        $(element).data("LastAddressValidated", address);

                        // We have a valid geocoded address
                        $(element).data("IsValid", true);
                    } else {
                        // Google Maps was able to geocode the address, but it wasn't specific
                        // enough (not enough commas) to be a valid street address.
                        $(element).data("IsValid", false);
                    }

                    // Otherwise the address is invalid
                } else {
                    $(element).data("IsValid", false);
                }

                // We're no longer in the midst of validating
                $(element).data("IsChecking", false);

                // Get the parent form element for this address field
                var form = $(element).parents('form:first');

                // This code is being run after the validation for this field,
                // if the form was being submitted before this validtor was 
                // called then we need to re-submit the form.
                if ($(element).data("SubmitForm") == true) {
                    form.submit();
                } else {
                    // Re-validate this property so we can return the result.
                    form.validate().element(element);
                }
            });

            // The FullAddress validator always returns 'true' when initially called.
            // The true result will be return later by the geocode function (above)
            return true;
        }

        // Define a new jQuery Validator method
        $.validator.addMethod("fulladdress", FullAddressValidator);
    </script> 
        
    </body>
</html>
